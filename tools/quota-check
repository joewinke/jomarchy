#!/usr/bin/env node
// Check AI model usage quotas
// Usage: quota-check
//        quota-check --model openai-gpt4
//        quota-check --brand <brand_id>

import { spawn } from 'child_process';

const args = process.argv.slice(2);

if (args.includes('--help') || args.includes('-h')) {
  console.log('Usage: quota-check [options]');
  console.log('\nOptions:');
  console.log('  --model <name>     Filter by model');
  console.log('  --brand <id>       Filter by brand');
  console.log('  --period <days>    Time period (default: 30)');
  console.log('\nExamples:');
  console.log('  quota-check');
  console.log('  quota-check --model openai-gpt4');
  console.log('  quota-check --brand 123e4567-e89b-12d3-a456-426614174000');
  process.exit(0);
}

const connectionString = process.env.DATABASE_URL || process.env.SUPABASE_DB_URL;
if (!connectionString) {
  console.error('✗ DATABASE_URL or SUPABASE_DB_URL environment variable required');
  process.exit(1);
}

let where = [`created_at > NOW() - INTERVAL '30 days'`];
let groupBy = 'model, brand_id';

for (let i = 0; i < args.length; i++) {
  if (args[i] === '--model') {
    where.push(`model = '${args[++i]}'`);
  } else if (args[i] === '--brand') {
    where.push(`brand_id = '${args[++i]}'`);
  } else if (args[i] === '--period') {
    where[0] = `created_at > NOW() - INTERVAL '${args[++i]} days'`;
  }
}

const whereClause = where.join(' AND ');

const query = `
  SELECT
    model,
    brand_id,
    COUNT(*) as request_count,
    SUM(tokens_used) as total_tokens,
    AVG(tokens_used) as avg_tokens,
    MAX(created_at) as last_used
  FROM ai_usage_logs
  WHERE ${whereClause}
  GROUP BY ${groupBy}
  ORDER BY total_tokens DESC
`;

const psql = spawn('psql', [connectionString, '-c', query], { stdio: 'inherit' });

psql.on('error', (error) => {
  console.error('✗ Failed to execute psql:', error.message);
  process.exit(1);
});

psql.on('close', (code) => {
  process.exit(code);
});
