#!/usr/bin/env node
// Fetch inbox messages for agent
// Usage: am-inbox <AgentName> [--unread] [--urgent] [--limit 20]

import { parseArgs, showHelp, amFetch, PROJECT_KEY, formatTable } from './am-lib.js';

const args = parseArgs(process.argv.slice(2));

if (args.flags.help || args.flags.h) {
  showHelp('am-inbox <AgentName> [options]', {
    '--project': 'Project key (default: current directory)',
    '--unread': 'Only unread messages',
    '--urgent': 'Only urgent messages',
    '--limit': 'Max messages (default: 20)',
    '--bodies': 'Include message bodies',
    '--json': 'Output as JSON'
  });
  process.exit(0);
}

const agentName = args._[0];
if (!agentName) {
  console.error('✗ Agent name required');
  console.error('Usage: am-inbox <AgentName>');
  process.exit(1);
}

try {
  const params = new URLSearchParams({
    project_key: PROJECT_KEY,
    agent_name: agentName,
    limit: args.flags.limit || 20,
    urgent_only: args.flags.urgent || false,
    include_bodies: args.flags.bodies || false
  });

  const messages = await amFetch(`/api/fetch_inbox?${params}`);

  if (args.flags.json) {
    console.log(JSON.stringify(messages, null, 2));
  } else {
    if (!messages || messages.length === 0) {
      console.log('Inbox empty');
      process.exit(0);
    }

    // Format as table
    const rows = messages.map(m => ({
      id: m.id,
      from: m.from,
      subject: m.subject.slice(0, 40),
      importance: m.importance,
      created: new Date(m.created_ts).toLocaleString()
    }));

    console.log(formatTable(rows, ['id', 'from', 'subject', 'importance', 'created']));
    console.log(`\nTotal: ${messages.length} messages`);

    if (args.flags.bodies) {
      console.log('\n--- Message Bodies ---\n');
      messages.forEach(m => {
        console.log(`[${m.id}] ${m.subject}`);
        console.log(m.body_md);
        console.log('---\n');
      });
    }
  }
} catch (error) {
  console.error('✗ Fetch failed:', error.message);
  process.exit(1);
}
