#!/usr/bin/env node
// Send message via Agent Mail
// Usage: am-send <subject> <body> --from <agent> --to <agent1,agent2> [--thread <id>]

import { parseArgs, showHelp, amFetch, PROJECT_KEY } from './am-lib.js';

const args = parseArgs(process.argv.slice(2));

if (args.flags.help || args.flags.h) {
  showHelp('am-send <subject> <body> [options]', {
    '--from': 'Sender agent name (required)',
    '--to': 'Recipient agent names (comma-separated, required)',
    '--cc': 'CC recipients (comma-separated)',
    '--thread': 'Thread ID',
    '--importance': 'normal, high, urgent (default: normal)',
    '--ack': 'Require acknowledgement',
    '--project': 'Project key (default: current directory)',
    '--json': 'Output as JSON'
  });
  process.exit(0);
}

const subject = args._[0];
const body = args._[1];

if (!subject || !body) {
  console.error('✗ Subject and body required');
  console.error('Usage: am-send <subject> <body> --from <agent> --to <agent1,agent2>');
  process.exit(1);
}

if (!args.flags.from || !args.flags.to) {
  console.error('✗ --from and --to required');
  process.exit(1);
}

const payload = {
  project_key: PROJECT_KEY,
  sender_name: args.flags.from,
  to: args.flags.to.split(',').map(s => s.trim()),
  subject,
  body_md: body,
  importance: args.flags.importance || 'normal',
  ack_required: args.flags.ack || false
};

if (args.flags.cc) {
  payload.cc = args.flags.cc.split(',').map(s => s.trim());
}

if (args.flags.thread) {
  payload.thread_id = args.flags.thread;
}

try {
  const result = await amFetch('/api/send_message', {
    method: 'POST',
    body: JSON.stringify(payload)
  });

  if (args.flags.json) {
    console.log(JSON.stringify(result, null, 2));
  } else {
    console.log(`✓ Message sent`);
    console.log(`  To: ${payload.to.join(', ')}`);
    console.log(`  Thread: ${result.deliveries[0]?.payload?.thread_id || '(new)'}`);
    console.log(`  Deliveries: ${result.count}`);
  }
} catch (error) {
  console.error('✗ Send failed:', error.message);
  process.exit(1);
}
