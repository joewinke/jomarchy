#!/usr/bin/env node
// Background job status dashboard
// Usage: job-monitor
//        job-monitor --failed
//        job-monitor --queue video-generation

import { spawn } from 'child_process';

const args = process.argv.slice(2);

if (args.includes('--help') || args.includes('-h')) {
  console.log('Usage: job-monitor [options]');
  console.log('\nOptions:');
  console.log('  --failed         Show only failed jobs');
  console.log('  --queue <name>   Filter by queue name');
  console.log('  --pending        Show only pending jobs');
  console.log('\nExamples:');
  console.log('  job-monitor');
  console.log('  job-monitor --failed');
  console.log('  job-monitor --queue video-generation');
  process.exit(0);
}

const connectionString = process.env.DATABASE_URL || process.env.SUPABASE_DB_URL;
if (!connectionString) {
  console.error('✗ DATABASE_URL or SUPABASE_DB_URL environment variable required');
  process.exit(1);
}

let where = [];

for (let i = 0; i < args.length; i++) {
  if (args[i] === '--failed') {
    where.push(`status = 'failed'`);
  } else if (args[i] === '--pending') {
    where.push(`status = 'pending'`);
  } else if (args[i] === '--queue') {
    where.push(`queue_name = '${args[++i]}'`);
  }
}

const whereClause = where.length > 0 ? `WHERE ${where.join(' AND ')}` : '';

const query = `
  SELECT
    id, queue_name, status,
    created_at, started_at, completed_at,
    error_message,
    EXTRACT(EPOCH FROM (COALESCE(completed_at, NOW()) - created_at)) as duration_seconds
  FROM background_jobs
  ${whereClause}
  ORDER BY created_at DESC
  LIMIT 50
`;

const psql = spawn('psql', [connectionString, '-c', query, '-x'], { stdio: 'inherit' });

psql.on('error', (error) => {
  console.error('✗ Failed to execute psql:', error.message);
  console.error('Note: This requires a background_jobs table');
  process.exit(1);
});

psql.on('close', (code) => {
  process.exit(code);
});
