#!/usr/bin/env node
// List all agents in project
// Usage: am-agents [--active] [--json]

import { parseArgs, showHelp, amFetch, PROJECT_KEY, formatTable } from './am-lib.js';

const args = parseArgs(process.argv.slice(2));

if (args.flags.help || args.flags.h) {
  showHelp('am-agents [options]', {
    '--project': 'Project key (default: current directory)',
    '--active': 'Only show recently active agents (last 24h)',
    '--json': 'Output as JSON',
    '--table': 'Output as table (default)'
  });
  process.exit(0);
}

try {
  const result = await amFetch(`/api/agents?project_key=${encodeURIComponent(PROJECT_KEY)}`);

  let agents = result.agents || [];

  // Filter active if requested
  if (args.flags.active) {
    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
    agents = agents.filter(a => new Date(a.last_active_ts) > oneDayAgo);
  }

  // Sort by last active (most recent first)
  agents.sort((a, b) => new Date(b.last_active_ts) - new Date(a.last_active_ts));

  if (args.flags.json) {
    console.log(JSON.stringify(agents, null, 2));
  } else {
    if (agents.length === 0) {
      console.log('No agents found');
      process.exit(0);
    }

    // Format as table
    const rows = agents.map(a => {
      const lastActive = new Date(a.last_active_ts);
      const hoursAgo = Math.floor((Date.now() - lastActive.getTime()) / (1000 * 60 * 60));
      const timeAgo = hoursAgo < 24 ? `${hoursAgo}h ago` : `${Math.floor(hoursAgo / 24)}d ago`;

      return {
        name: a.name,
        model: a.model,
        task: (a.task_description || '').slice(0, 50),
        unread: a.unread_count || 0,
        active: timeAgo
      };
    });

    console.log(formatTable(rows, ['name', 'model', 'task', 'unread', 'active']));
    console.log(`\nTotal: ${agents.length} agents`);
  }
} catch (error) {
  console.error('âœ— Query failed:', error.message);
  process.exit(1);
}
