#!/usr/bin/env node
// Monitor batch video generation jobs
// Usage: video-status <batch_id>
//        video-status --all-pending
//        video-status --failed

import { spawn } from 'child_process';

const args = process.argv.slice(2);

if (args.length === 0 || args.includes('--help') || args.includes('-h')) {
  console.log('Usage: video-status <batch_id>');
  console.log('       video-status --all-pending');
  console.log('       video-status --failed');
  console.log('       video-status --user <user_id>');
  console.log('\nExamples:');
  console.log('  video-status 123e4567-e89b-12d3-a456-426614174000');
  console.log('  video-status --all-pending');
  console.log('  video-status --failed');
  process.exit(0);
}

const connectionString = process.env.DATABASE_URL || process.env.SUPABASE_DB_URL;
if (!connectionString) {
  console.error('✗ DATABASE_URL or SUPABASE_DB_URL environment variable required');
  process.exit(1);
}

let query;

if (args[0] === '--all-pending') {
  query = `
    SELECT
      vb.id, vb.name, vb.status,
      vb.created_at, vb.updated_at,
      COUNT(vbi.id) as total_items,
      COUNT(vbi.id) FILTER (WHERE vbi.status = 'completed') as completed,
      COUNT(vbi.id) FILTER (WHERE vbi.status = 'failed') as failed
    FROM video_batches vb
    LEFT JOIN video_batch_items vbi ON vb.id = vbi.batch_id
    WHERE vb.status IN ('pending', 'processing')
    GROUP BY vb.id, vb.name, vb.status, vb.created_at, vb.updated_at
    ORDER BY vb.created_at DESC
  `;
} else if (args[0] === '--failed') {
  query = `
    SELECT
      vb.id, vb.name,
      COUNT(vbi.id) as failed_count,
      MAX(vbi.error_message) as sample_error
    FROM video_batches vb
    JOIN video_batch_items vbi ON vb.id = vbi.batch_id
    WHERE vbi.status = 'failed'
    GROUP BY vb.id, vb.name
    ORDER BY failed_count DESC
    LIMIT 20
  `;
} else if (args[0] === '--user') {
  const userId = args[1];
  query = `
    SELECT
      vb.id, vb.name, vb.status,
      COUNT(vbi.id) as total_items,
      COUNT(vbi.id) FILTER (WHERE vbi.status = 'completed') as completed
    FROM video_batches vb
    LEFT JOIN video_batch_items vbi ON vb.id = vbi.batch_id
    WHERE vb.created_by = '${userId}'
    GROUP BY vb.id, vb.name, vb.status
    ORDER BY vb.created_at DESC
    LIMIT 20
  `;
} else {
  const batchId = args[0];
  query = `
    SELECT
      vb.*,
      COUNT(vbi.id) as total_items,
      COUNT(vbi.id) FILTER (WHERE vbi.status = 'completed') as completed,
      COUNT(vbi.id) FILTER (WHERE vbi.status = 'failed') as failed,
      COUNT(vbi.id) FILTER (WHERE vbi.status = 'pending') as pending
    FROM video_batches vb
    LEFT JOIN video_batch_items vbi ON vb.id = vbi.batch_id
    WHERE vb.id = '${batchId}'
    GROUP BY vb.id
  `;
}

const psql = spawn('psql', [connectionString, '-c', query, '-x'], { stdio: 'inherit' });

psql.on('error', (error) => {
  console.error('✗ Failed to execute psql:', error.message);
  process.exit(1);
});

psql.on('close', (code) => {
  process.exit(code);
});
