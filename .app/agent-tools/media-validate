#!/usr/bin/env node
// Check media file integrity and accessibility
// Usage: media-validate <asset_id>
//        media-validate --batch <batch_id>
//        media-validate --missing

import { spawn } from 'child_process';

const args = process.argv.slice(2);

if (args.length === 0 || args.includes('--help') || args.includes('-h')) {
  console.log('Usage: media-validate <asset_id>');
  console.log('       media-validate --batch <batch_id>');
  console.log('       media-validate --missing');
  console.log('       media-validate --broken');
  console.log('\nExamples:');
  console.log('  media-validate 123e4567-e89b-12d3-a456-426614174000');
  console.log('  media-validate --missing      # Find assets with NULL storage_path');
  console.log('  media-validate --broken       # Find assets with inaccessible files');
  process.exit(0);
}

const connectionString = process.env.DATABASE_URL || process.env.SUPABASE_DB_URL;
if (!connectionString) {
  console.error('✗ DATABASE_URL or SUPABASE_DB_URL environment variable required');
  process.exit(1);
}

let query;

if (args[0] === '--missing') {
  query = `
    SELECT
      id, name, asset_type, brand_id, created_at
    FROM assets
    WHERE storage_path IS NULL OR storage_path = ''
    ORDER BY created_at DESC
    LIMIT 50
  `;
} else if (args[0] === '--broken') {
  console.log('⚠️  --broken flag requires Supabase Storage API integration');
  console.log('Showing assets that might be broken (heuristic checks):\n');
  query = `
    SELECT
      id, name, storage_path, file_size, created_at
    FROM assets
    WHERE file_size IS NULL OR file_size = 0
    ORDER BY created_at DESC
    LIMIT 50
  `;
} else if (args[0] === '--batch') {
  const batchId = args[1];
  query = `
    SELECT
      a.id, a.name, a.storage_path, a.file_size,
      vbi.status as batch_item_status
    FROM assets a
    JOIN video_batch_items vbi ON a.id = vbi.asset_id
    WHERE vbi.batch_id = '${batchId}'
    ORDER BY vbi.created_at
  `;
} else {
  const assetId = args[0];
  query = `
    SELECT
      id, name, asset_type, storage_path,
      file_size, metadata, created_at
    FROM assets
    WHERE id = '${assetId}'
  `;
}

const psql = spawn('psql', [connectionString, '-c', query, '-x'], { stdio: 'inherit' });

psql.on('error', (error) => {
  console.error('✗ Failed to execute psql:', error.message);
  process.exit(1);
});

psql.on('close', (code) => {
  process.exit(code);
});
