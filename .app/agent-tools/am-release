#!/usr/bin/env node
// Release file reservations
// Usage: am-release [paths...] --agent <AgentName>

import { parseArgs, showHelp, amFetch, PROJECT_KEY } from './am-lib.js';

const args = parseArgs(process.argv.slice(2));

if (args.flags.help || args.flags.h) {
  showHelp('am-release [paths...] [options]', {
    '--agent': 'Agent name (required)',
    '--all': 'Release all reservations for agent',
    '--project': 'Project key (default: current directory)',
    '--json': 'Output as JSON'
  });
  process.exit(0);
}

if (!args.flags.agent) {
  console.error('✗ --agent required');
  process.exit(1);
}

const paths = args._;
if (paths.length === 0 && !args.flags.all) {
  console.error('✗ Specify paths or use --all');
  process.exit(1);
}

try {
  const payload = {
    project_key: PROJECT_KEY,
    agent_name: args.flags.agent
  };

  if (paths.length > 0) {
    payload.paths = paths;
  }

  const result = await amFetch('/api/release_file_reservations', {
    method: 'POST',
    body: JSON.stringify(payload)
  });

  if (args.flags.json) {
    console.log(JSON.stringify(result, null, 2));
  } else {
    console.log(`✓ Released ${result.released} reservations`);
    console.log(`  Released at: ${result.released_at}`);
  }
} catch (error) {
  console.error('✗ Release failed:', error.message);
  process.exit(1);
}
