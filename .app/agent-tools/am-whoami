#!/usr/bin/env node
// Show current agent identity information
// Usage: am-whoami [AgentName] [--json]

import { parseArgs, showHelp, amFetch, PROJECT_KEY } from './am-lib.js';

const args = parseArgs(process.argv.slice(2));

if (args.flags.help || args.flags.h) {
  showHelp('am-whoami [AgentName] [options]', {
    '--project': 'Project key (default: current directory)',
    '--commits': 'Include recent commits (default: true)',
    '--json': 'Output as JSON'
  });
  process.exit(0);
}

const agentName = args._[0];
if (!agentName) {
  console.error('✗ Agent name required');
  console.error('Usage: am-whoami <AgentName>');
  process.exit(1);
}

try {
  const result = await amFetch(`/api/whois?project_key=${encodeURIComponent(PROJECT_KEY)}&agent_name=${encodeURIComponent(agentName)}&include_recent_commits=${args.flags.commits !== false}`);

  if (args.flags.json) {
    console.log(JSON.stringify(result, null, 2));
  } else {
    console.log(`Agent: ${result.name}`);
    console.log(`Program: ${result.program}`);
    console.log(`Model: ${result.model}`);
    console.log(`Task: ${result.task_description || '(none)'}`);
    console.log(`Created: ${result.inception_ts}`);
    console.log(`Last active: ${result.last_active_ts}`);

    if (result.recent_commits && result.recent_commits.length > 0) {
      console.log('\nRecent commits:');
      result.recent_commits.forEach(commit => {
        console.log(`  ${commit.hexsha.slice(0, 8)} ${commit.summary}`);
      });
    }
  }
} catch (error) {
  console.error('✗ Query failed:', error.message);
  process.exit(1);
}
