#!/usr/bin/env node
// Reply to a message
// Usage: am-reply <message_id> <body> --from <agent>

import { parseArgs, showHelp, amFetch, PROJECT_KEY } from './am-lib.js';

const args = parseArgs(process.argv.slice(2));

if (args.flags.help || args.flags.h) {
  showHelp('am-reply <message_id> <body> [options]', {
    '--from': 'Sender agent name (required)',
    '--to': 'Override recipients (comma-separated)',
    '--cc': 'CC recipients (comma-separated)',
    '--project': 'Project key (default: current directory)',
    '--json': 'Output as JSON'
  });
  process.exit(0);
}

const messageId = parseInt(args._[0]);
const body = args._[1];

if (!messageId || !body) {
  console.error('✗ Message ID and body required');
  console.error('Usage: am-reply <message_id> <body> --from <agent>');
  process.exit(1);
}

if (!args.flags.from) {
  console.error('✗ --from required');
  process.exit(1);
}

const payload = {
  project_key: PROJECT_KEY,
  message_id: messageId,
  sender_name: args.flags.from,
  body_md: body
};

if (args.flags.to) {
  payload.to = args.flags.to.split(',').map(s => s.trim());
}

if (args.flags.cc) {
  payload.cc = args.flags.cc.split(',').map(s => s.trim());
}

try {
  const result = await amFetch('/api/reply_message', {
    method: 'POST',
    body: JSON.stringify(payload)
  });

  if (args.flags.json) {
    console.log(JSON.stringify(result, null, 2));
  } else {
    console.log(`✓ Reply sent`);
    console.log(`  Thread: ${result.thread_id}`);
    console.log(`  In reply to: ${result.reply_to}`);
  }
} catch (error) {
  console.error('✗ Reply failed:', error.message);
  process.exit(1);
}
