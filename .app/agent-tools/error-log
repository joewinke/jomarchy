#!/usr/bin/env node
// Recent application errors
// Usage: error-log --last 1h
//        error-log --pattern "video generation"
//        error-log --user <user_id>

import { spawn } from 'child_process';

const args = process.argv.slice(2);

if (args.includes('--help') || args.includes('-h')) {
  console.log('Usage: error-log [options]');
  console.log('\nOptions:');
  console.log('  --last <time>    Time range (1h, 24h, 7d)');
  console.log('  --pattern <str>  Filter by error message');
  console.log('  --user <id>      Filter by user');
  console.log('  --count          Just show counts by type');
  console.log('\nExamples:');
  console.log('  error-log --last 1h');
  console.log('  error-log --pattern "video generation"');
  console.log('  error-log --count');
  process.exit(0);
}

const connectionString = process.env.DATABASE_URL || process.env.SUPABASE_DB_URL;
if (!connectionString) {
  console.error('✗ DATABASE_URL or SUPABASE_DB_URL environment variable required');
  process.exit(1);
}

let where = [];
let isCount = false;

for (let i = 0; i < args.length; i++) {
  if (args[i] === '--last') {
    const time = args[++i];
    where.push(`created_at > NOW() - INTERVAL '${time}'`);
  } else if (args[i] === '--pattern') {
    const pattern = args[++i].replace(/'/g, "''");
    where.push(`message ILIKE '%${pattern}%'`);
  } else if (args[i] === '--user') {
    where.push(`user_id = '${args[++i]}'`);
  } else if (args[i] === '--count') {
    isCount = true;
  }
}

const whereClause = where.length > 0 ? `WHERE ${where.join(' AND ')}` : `WHERE created_at > NOW() - INTERVAL '24 hours'`;

let query;
if (isCount) {
  query = `
    SELECT
      error_type,
      COUNT(*) as count,
      MAX(created_at) as last_occurrence
    FROM error_logs
    ${whereClause}
    GROUP BY error_type
    ORDER BY count DESC
  `;
} else {
  query = `
    SELECT
      id, error_type, message,
      user_id, created_at,
      LEFT(stack_trace, 100) as stack_preview
    FROM error_logs
    ${whereClause}
    ORDER BY created_at DESC
    LIMIT 50
  `;
}

const psql = spawn('psql', [connectionString, '-c', query, '-x'], { stdio: 'inherit' });

psql.on('error', (error) => {
  console.error('✗ Failed to execute psql:', error.message);
  console.error('Note: This requires an error_logs table');
  process.exit(1);
});

psql.on('close', (code) => {
  process.exit(code);
});
