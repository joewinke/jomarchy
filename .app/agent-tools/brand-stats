#!/usr/bin/env node
// Brand-level usage statistics
// Usage: brand-stats <brand_id>
//        brand-stats --all --summary

import { spawn } from 'child_process';

const args = process.argv.slice(2);

if (args.includes('--help') || args.includes('-h')) {
  console.log('Usage: brand-stats <brand_id>');
  console.log('       brand-stats --all --summary');
  console.log('\nExamples:');
  console.log('  brand-stats 123e4567-e89b-12d3-a456-426614174000');
  console.log('  brand-stats --all --summary');
  process.exit(0);
}

const connectionString = process.env.DATABASE_URL || process.env.SUPABASE_DB_URL;
if (!connectionString) {
  console.error('✗ DATABASE_URL required');
  process.exit(1);
}

let query;

if (args[0] === '--all') {
  query = `
    SELECT
      b.name,
      COUNT(DISTINCT bm.user_id) as members,
      COUNT(DISTINCT a.id) as assets,
      SUM(a.file_size) as total_storage,
      MAX(a.created_at) as last_asset_created
    FROM brands b
    LEFT JOIN brand_members bm ON b.id = bm.brand_id
    LEFT JOIN assets a ON b.id = a.brand_id
    GROUP BY b.id, b.name
    ORDER BY total_storage DESC NULLS LAST
    LIMIT 50
  `;
} else {
  const brandId = args[0];
  query = `
    SELECT
      b.*,
      COUNT(DISTINCT bm.user_id) as member_count,
      COUNT(DISTINCT a.id) as asset_count,
      SUM(a.file_size) as total_storage_bytes,
      pg_size_pretty(SUM(a.file_size)::bigint) as storage_size,
      COUNT(DISTINCT cs.id) as chat_sessions
    FROM brands b
    LEFT JOIN brand_members bm ON b.id = bm.brand_id
    LEFT JOIN assets a ON b.id = a.brand_id
    LEFT JOIN chat_sessions cs ON b.id = cs.brand_id
    WHERE b.id = '${brandId}'
    GROUP BY b.id
  `;
}

const psql = spawn('psql', [connectionString, '-c', query, '-x'], { stdio: 'inherit' });
psql.on('error', (e) => { console.error('✗', e.message); process.exit(1); });
psql.on('close', (code) => process.exit(code));
