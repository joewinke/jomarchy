#!/usr/bin/env node
// Search messages
// Usage: am-search <query> [--limit 20]

import { parseArgs, showHelp, amFetch, PROJECT_KEY, formatTable } from './am-lib.js';

const args = parseArgs(process.argv.slice(2));

if (args.flags.help || args.flags.h) {
  showHelp('am-search <query> [options]', {
    '--limit': 'Max results (default: 20)',
    '--project': 'Project key (default: current directory)',
    '--json': 'Output as JSON'
  });
  process.exit(0);
}

const query = args._.join(' ');

if (!query) {
  console.error('✗ Search query required');
  console.error('Usage: am-search <query>');
  process.exit(1);
}

try {
  const params = new URLSearchParams({
    project_key: PROJECT_KEY,
    query,
    limit: args.flags.limit || 20
  });

  const results = await amFetch(`/api/search_messages?${params}`);

  if (args.flags.json) {
    console.log(JSON.stringify(results, null, 2));
  } else {
    if (!results || results.length === 0) {
      console.log('No results found');
      process.exit(0);
    }

    // Format as table
    const rows = results.map(m => ({
      id: m.id,
      subject: m.subject.slice(0, 50),
      from: m.from,
      importance: m.importance,
      created: new Date(m.created_ts).toLocaleString()
    }));

    console.log(formatTable(rows, ['id', 'subject', 'from', 'importance', 'created']));
    console.log(`\nTotal: ${results.length} results`);
  }
} catch (error) {
  console.error('✗ Search failed:', error.message);
  process.exit(1);
}
