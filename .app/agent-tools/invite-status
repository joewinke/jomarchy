#!/usr/bin/env node
// Track pending team invitations
// Usage: invite-status
//        invite-status --brand <brand_id>
//        invite-status --expired

import { spawn } from 'child_process';

const args = process.argv.slice(2);

if (args.includes('--help') || args.includes('-h')) {
  console.log('Usage: invite-status [options]');
  console.log('\nOptions:');
  console.log('  --brand <id>  Filter by brand');
  console.log('  --expired     Show expired invitations');
  console.log('  --pending     Show pending only');
  console.log('\nExamples:');
  console.log('  invite-status');
  console.log('  invite-status --brand 123e4567');
  console.log('  invite-status --expired');
  process.exit(0);
}

const connectionString = process.env.DATABASE_URL || process.env.SUPABASE_DB_URL;
if (!connectionString) {
  console.error('✗ DATABASE_URL required');
  process.exit(1);
}

let where = [];

for (let i = 0; i < args.length; i++) {
  if (args[i] === '--brand') {
    where.push(`brand_id = '${args[++i]}'`);
  } else if (args[i] === '--expired') {
    where.push(`expires_at < NOW()`);
  } else if (args[i] === '--pending') {
    where.push(`status = 'pending' AND expires_at > NOW()`);
  }
}

const whereClause = where.length > 0 ? `WHERE ${where.join(' AND ')}` : '';

const query = `
  SELECT
    email, role, status,
    created_at, expires_at,
    CASE
      WHEN expires_at < NOW() THEN 'expired'
      WHEN status = 'accepted' THEN 'accepted'
      ELSE 'pending'
    END as current_status
  FROM team_invitations
  ${whereClause}
  ORDER BY created_at DESC
  LIMIT 50
`;

const psql = spawn('psql', [connectionString, '-c', query], { stdio: 'inherit' });
psql.on('error', (e) => { console.error('✗', e.message); process.exit(1); });
psql.on('close', (code) => process.exit(code));
