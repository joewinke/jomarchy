#!/usr/bin/env bash
# Identify slow queries and routes
# Usage: perf-check
#        perf-check --slow-queries
#        perf-check --route "/api/video/generate"

if [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
  echo "Usage: perf-check [options]"
  echo ""
  echo "Options:"
  echo "  --slow-queries   Show slowest database queries"
  echo "  --route <path>   Check specific route performance"
  echo "  --summary        Show overall performance summary"
  echo ""
  echo "Examples:"
  echo "  perf-check --slow-queries"
  echo "  perf-check --route /api/video/generate"
  echo "  perf-check --summary"
  exit 0
fi

CONNECTION_STRING="${DATABASE_URL:-$SUPABASE_DB_URL}"

if [ -z "$CONNECTION_STRING" ]; then
  echo "âœ— DATABASE_URL or SUPABASE_DB_URL environment variable required"
  exit 1
fi

if [ "$1" == "--slow-queries" ]; then
  echo "Slowest queries (requires pg_stat_statements extension):"
  psql "$CONNECTION_STRING" -c "
    SELECT
      substring(query, 1, 80) as query_preview,
      calls,
      ROUND(total_exec_time::numeric, 2) as total_ms,
      ROUND(mean_exec_time::numeric, 2) as mean_ms,
      ROUND((100 * total_exec_time / SUM(total_exec_time) OVER())::numeric, 2) as pct
    FROM pg_stat_statements
    ORDER BY total_exec_time DESC
    LIMIT 20
  "
elif [ "$1" == "--route" ]; then
  ROUTE="$2"
  echo "Performance for route: $ROUTE"
  echo "(requires request_logs table)"
  psql "$CONNECTION_STRING" -c "
    SELECT
      COUNT(*) as requests,
      ROUND(AVG(duration_ms)::numeric, 2) as avg_ms,
      ROUND(PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY duration_ms)::numeric, 2) as p50_ms,
      ROUND(PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY duration_ms)::numeric, 2) as p95_ms,
      ROUND(PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY duration_ms)::numeric, 2) as p99_ms
    FROM request_logs
    WHERE route = '$ROUTE'
    AND created_at > NOW() - INTERVAL '24 hours'
  "
else
  echo "=== Performance Summary ==="
  echo ""
  echo "Slow queries:"
  psql "$CONNECTION_STRING" -c "
    SELECT
      substring(query, 1, 60) as query,
      calls,
      ROUND(mean_exec_time::numeric, 2) as mean_ms
    FROM pg_stat_statements
    WHERE mean_exec_time > 100
    ORDER BY mean_exec_time DESC
    LIMIT 10
  " 2>/dev/null || echo "  pg_stat_statements not available"
  echo ""
  echo "Database size:"
  psql "$CONNECTION_STRING" -c "
    SELECT
      pg_size_pretty(pg_database_size(current_database())) as size
  "
fi
